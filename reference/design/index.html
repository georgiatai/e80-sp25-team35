<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Reference Designs – E80 SP24</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-d4d76bf8491c20bad77d141916dc28e1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-fb2a98436b8dcabd7258a17b2be278e3.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">E80 SP24</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../lectures/"> 
<span class="menu-text">Lectures</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-labs" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Labs</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-labs">    
        <li>
    <a class="dropdown-item" href="../../labs/overview">
 <span class="dropdown-text">Overview and Safety</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab0">
 <span class="dropdown-text">Lab 0: Tutorial &amp; Skills Review</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab1">
 <span class="dropdown-text">Lab 1: Go Autonomous</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab2">
 <span class="dropdown-text">Lab 2: BEM</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab3">
 <span class="dropdown-text">Lab 3: Op-Amps</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab4">
 <span class="dropdown-text">Lab 4: Temperature</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab5">
 <span class="dropdown-text">Lab 5: Acoustics</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../labs/lab6">
 <span class="dropdown-text">Lab 6: Fluids</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-project" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Project</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-project">    
        <li>
    <a class="dropdown-item" href="../../project/overview">
 <span class="dropdown-text">Overview</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project/proposal">
 <span class="dropdown-text">Design and Proposal</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project/navigation">
 <span class="dropdown-text">Navigation Jump Start</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project/build">
 <span class="dropdown-text">Build and Integrate</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project/deploy">
 <span class="dropdown-text">Field Deployment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../project/report">
 <span class="dropdown-text">Present and Report</span></a>
  </li>  
    </ul>
  </li>
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-references" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">References</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-references">    
        <li>
    <a class="dropdown-item" href="../../reference/inventory">
 <span class="dropdown-text">Lab Inventory</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/equipment">
 <span class="dropdown-text">Lab Equipment</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/board">
 <span class="dropdown-text">Board Information</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/design">
 <span class="dropdown-text">Reference Designs</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../../reference/history">
 <span class="dropdown-text">Old Final Projects</span></a>
  </li>  
    </ul>
  </li>
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/HMC-E80/E80"> <i class="bi bi-github" role="img" aria-label="GitHub">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#phase-shift-oscillator" id="toc-phase-shift-oscillator" class="nav-link active" data-scroll-target="#phase-shift-oscillator">Phase Shift Oscillator</a></li>
  <li><a href="#sine-wave-generator" id="toc-sine-wave-generator" class="nav-link" data-scroll-target="#sine-wave-generator">555 Sine Wave Generator</a></li>
  <li><a href="#maximum-and-minimum-detectors" id="toc-maximum-and-minimum-detectors" class="nav-link" data-scroll-target="#maximum-and-minimum-detectors">Maximum and Minimum Detectors</a></li>
  <li><a href="#variable-gain" id="toc-variable-gain" class="nav-link" data-scroll-target="#variable-gain">Variable Gain</a></li>
  <li><a href="#salinity-sensor" id="toc-salinity-sensor" class="nav-link" data-scroll-target="#salinity-sensor">Salinity Sensor</a></li>
  <li><a href="#ph-sensor-and-interface-circuit" id="toc-ph-sensor-and-interface-circuit" class="nav-link" data-scroll-target="#ph-sensor-and-interface-circuit">PH Sensor and Interface Circuit</a></li>
  <li><a href="#thermocouple-interface-circuit" id="toc-thermocouple-interface-circuit" class="nav-link" data-scroll-target="#thermocouple-interface-circuit">Thermocouple Interface Circuit</a></li>
  <li><a href="#acoustic-time-of-flight-distance-measurements" id="toc-acoustic-time-of-flight-distance-measurements" class="nav-link" data-scroll-target="#acoustic-time-of-flight-distance-measurements">Acoustic Time-of-flight Distance Measurements</a></li>
  <li><a href="#auv-turbidity-meter" id="toc-auv-turbidity-meter" class="nav-link" data-scroll-target="#auv-turbidity-meter">AUV Turbidity Meter</a></li>
  <li><a href="#anemometer" id="toc-anemometer" class="nav-link" data-scroll-target="#anemometer">Anemometer</a></li>
  <li><a href="#weather-vane" id="toc-weather-vane" class="nav-link" data-scroll-target="#weather-vane">Weather Vane</a></li>
  <li><a href="#velocity-sensors" id="toc-velocity-sensors" class="nav-link" data-scroll-target="#velocity-sensors">Velocity Sensors</a></li>
  <li><a href="#future-designs" id="toc-future-designs" class="nav-link" data-scroll-target="#future-designs">Future Designs</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Reference Designs</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="phase-shift-oscillator" class="level2">
<h2 class="anchored" data-anchor-id="phase-shift-oscillator">Phase Shift Oscillator</h2>
<div id="fig-phase-shift-osc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-phase-shift-osc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/phase_shift_osc.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-phase-shift-osc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Phase Shift Oscillator
</figcaption>
</figure>
</div>
<p>Phase shift oscillators produce sinusoidal outputs. The oscillation frequency in Hz is given by <span class="math inline">\(f_{osc} = \sqrt{3}/(2\pi RC)\)</span>. In order for this to operate, <span class="math inline">\(R_1/R_2\)</span> must be 8, and it helps if <span class="math inline">\(R_2\)</span> is fairly large (&gt;100 k<span class="math inline">\(\Omega\)</span>). The oscillation amplitude is hard to control, but we’ve seen ~ 1 Vpp in the past. The oscillation tends to be centered mid-rail. Since this requires four op-amps, it’s natural to implement it on one MCP6004.</p>
</section>
<section id="sine-wave-generator" class="level2">
<h2 class="anchored" data-anchor-id="sine-wave-generator">555 Sine Wave Generator</h2>
<div id="fig-555-osc" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-555-osc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/555sine.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-555-osc-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: 555 Square Wave Generator and LC Low Pass Filter
</figcaption>
</figure>
</div>
<p>You can use 555 timers to produce sinusoidal outputs by attaching a low-pass filter to the output of a square wave generator. If the frequency of the low-pass is low enough, then harmonics of the square wave will be attenuated. We recommend a LC low-pass filter here because it’s a second order filter instead of a first order filter. This design has well-controlled frequency (see <a href="../../labs/lab3/index.html">lab 3</a> for setting the 555 frequency), and it’s easy to control its amplitude (by setting VCC, perhaps with a voltage regulator). However, it doesn’t produce pure sine waves, it’s sometimes tricky to control its offset, and it’s very susceptible to power supply inductance: bypassing and careful layout are important to avoid intermittent errors with this design.</p>
</section>
<section id="maximum-and-minimum-detectors" class="level2">
<h2 class="anchored" data-anchor-id="maximum-and-minimum-detectors">Maximum and Minimum Detectors</h2>
<div id="fig-minmax" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-minmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-minmax" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-max-detect" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-max-detect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/max_detect.png" class="img-fluid figure-img" data-ref-parent="fig-minmax">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-max-detect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Max Detector
</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-minmax" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-min-detect" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-min-detect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/min_detect.png" class="img-fluid figure-img" data-ref-parent="fig-minmax">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-min-detect-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Min Detector
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-minmax-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;3: Maximum and minimum detector circuits.
</figcaption>
</figure>
</div>
<p>Maximum and minimum detector circuits use a combination of a diode and a low-pass filter to have asymmetric charge and discharge time constants. Considering the max detector circuit as an example: the capacitor can charge quickly through the diode, but only discharges slowly through the resistor. This means the circuit will hold maxima of the input waveform. This behavior is particularly effective when the input is periodic because the input will refresh the charge on the capacitance each period, reducing the effect of the slow RC decay in the output. The RC discharge allows the detector to be updated if the amplitude of the input sinusoid changes. Select the RC time constant to be larger than the input period and smaller than the period of changes in your amplitude.</p>
<p>The op-amp serves to match the voltage on the capacitor to the input voltage, effectively hiding the typical 0.7 V drop across the diode. However, this has the effect of limiting the maximum or minimum output: in the case of the max detector, the capacitor output can’t go higher than 0.7V below the op-amp maximum output.</p>
</section>
<section id="variable-gain" class="level2">
<h2 class="anchored" data-anchor-id="variable-gain">Variable Gain</h2>
<div id="fig-vga" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-vga-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/variable_gain.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-vga-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;4: An inverting amplifier with a variable gain controlled by a Teensy pin
</figcaption>
</figure>
</div>
<p>This amplifier has a gain that can be controlled by the Teensy, which can be useful if you’re really unsure of the size of your input signal. The gain here is <span class="math inline">\(-R_f/R_i\)</span> as usual, with the wrinkle that <span class="math inline">\(R_f\)</span> is made up of some combination of <span class="math inline">\(R_{f1}\)</span> and <span class="math inline">\(R_{f2}\)</span>. The Teensy pin controls a switch that puts <span class="math inline">\(R_{f2}\)</span> in parallel with <span class="math inline">\(R_{f1}\)</span>, and thereby changes the total effective <span class="math inline">\(R_f\)</span>. You can achieve more gain control with more parallel feedback branches.</p>
<p>The switch is drawn as a N-type MOSFET, and that will work well for most final projects. However, there are some subtleties to selecting a transistor switch like this, and you can talk to a professor if your think your switch is acting strangely.</p>
<p>It’s also possible to simplify this design by replacing the transistor switch with a <a href="https://electronics.stackexchange.com/questions/74259/how-are-jumpers-used">jumper</a> that you manually install before deploying. Doing so will let you tune your gain to specific values by adding and removing jumpers, which doesn’t require soldering. This is particularly handy if you need to trim your gain during deployment. However, doing this presents other potential challenges: be sure to record your jumper configuration for each deployment, and make sure your jumpers aren’t mechanically sensitive. Extending this idea, you can simplify even further by replacing eliminating the <span class="math inline">\(R_{f2}\)</span> path and replacing <span class="math inline">\(R_{f1}\)</span> with a <a href="http://www.resistorguide.com/potentiometer/">potentiometer</a> (a variable resistor), but doing so poses significant deployment challenges since you need to measure your potentiometer value before each deployment.</p>
</section>
<section id="salinity-sensor" class="level2">
<h2 class="anchored" data-anchor-id="salinity-sensor">Salinity Sensor</h2>
<p>Salinity is a measure of the total dissolved salt content of water. It is an extremely important and common measurement in oceanographic studies. Salinity measurements are used to track the flow of water and map the hydrological cycle, calibrate acoustic communication links, and understand biological phenomena like algal blooms.</p>
<p>You measure salinity by measuring salt water’s conductivity, then backing out the salt concentration that would result in that conductivity. Some online calculators can help with this process. <a href="http://www.fivecreeks.org/monitor/sal.shtml">This</a> converts from a measured conductivity to salinity, and <a href="https://www.hamzasreef.com/Contents/Calculators/SalinityConversion.php">this</a> converts from salinity to conductivity. Note that both converters depend on water temperature, so you’ll probably need to deploy a temperature probe at the same time. Here’s an example of some <a href="https://drive.google.com/file/d/1wtEeyfcI0ObH-54Jn9V4pzgGdI38T4-9/view?usp=sharing">measurements</a> performed by E80 staff that show the temperature effects.</p>
<p>Salt, water and electrons will undergo chemical reactions at the surface of your salinity probe that can deposit metal salts on your electrodes. These salts can form non-conductive films that corrupt your conductivity measurements. You can prevent salt buildup by reversing the surface reactions, so applying an AC voltage to your probe prevents buildup over time. This same chemistry can also cause your circuit to fail if the electrode area is too small or the voltage applied to the solution is too low. We also recommend stainless steel as your probe material. Stainless steel wire can help too because salt water readily corrodes copper.</p>
<p>With these considerations, we recommend the following circuit to measure salinity.</p>
<div id="fig-salinity" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-salinity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/salinity.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-salinity-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;5: A salinity sensor
</figcaption>
</figure>
</div>
<p>This circuit consists of an oscillator, which can be implemented as a phase shift oscillator, a 555 oscillator, or another oscillator of your choice, an offset amplifier gain stage, a max detector and a min detector. Each of these components has a purpose</p>
<ul>
<li>The oscillator stimulates the probe with an alternating Voltage to prevent buildup of metal salts. You need to pick the frequency to get the best possible measurement, which is complicated because the probe equivalent circuit is a resistor in parallel with a capacitor. You may want to read <a href="https://drive.google.com/file/d/1wtEeyfcI0ObH-54Jn9V4pzgGdI38T4-9/view">this</a> reference for further information. The exact R and C of your probe depend on probe construction, notably because the separation of probes is a key component of calculating both resistance and capacitance.</li>
<li>The positive input of the op-amp is set to mid rail in order to pin the negative input at the same voltage, which also helps prevent metal salt buildup. The voltage across the probe is set by the difference between the oscillator voltage and the negative input, and setting the negative input to mid-rail guarantees zero DC voltage on the probe because oscillators usually oscillate above and below mid-rail.</li>
<li>The offset amplifier scales and shifts the oscillator output. Select RF to achieve your desired output amplitude. The output amplitude is directly proportional to probe conductivity because the gain is <span class="math inline">\(-R_f/R_i = -R_f \cdot G_{probe}\)</span>. Picking RF will require you to know the conductivity of the solutions you’ll test in, fortunately there are many references that can help you find the expected salinity and conductivity of the ocean.</li>
<li>Measuring amplitude of an oscillating signal is hard with the Teensy because of its slow sampling rate. The max and min detectors make it possible for the Teensy pins on the far right to pick off amplitude without any risk of sampling in the middle of the sine wave.</li>
</ul>
<p>Calibration curves for salinity sensors are typically log-log plots of output Voltage vs.&nbsp;input concentration.</p>
</section>
<section id="ph-sensor-and-interface-circuit" class="level2">
<h2 class="anchored" data-anchor-id="ph-sensor-and-interface-circuit">PH Sensor and Interface Circuit</h2>
<p>pH needs no introduction, but in oceanography it can be an important indicator of acidic runoff from the surface. The pH of the water also has a strong impact on the health of various plant and animal species, notably coral. You will build a circuit to interact with a pH sensor and calibrate it against buffer solutions.</p>
<p>We stock a small number of <a href="https://www.pasco.com/prodCatalog/PS/PS-2102_pasport-ph-sensor/">Pasco pH electrodes</a> for pH measurements. These electrodes are usually used with interface boxes provided by Pasco (the Pasport system), but you can hook circuits directly to the BNC connector of the pH probe.</p>
<p>The pH probes are delicate instruments, so be sure to always re-cap them in a bath of pH 7 buffer solution and never leave them sitting exposed to air. Rinse them in a bath of deionized water and shake off any excess droplets before returning them to buffer solution. Buffer solutions are relatively expensive chemicals, so use them thoughtfully: Use the smaller 50mL beakers to hold buffer solutions at your station and take pains not to spill any buffer solution when pouring it from the main supply. Buffer solutions may be rinsed down the sink when you are done with them.</p>
<p>The probes need special care to make repeatable and accurate measurements, so a few experimental tips will help you to get consistent results when taking calibration measurements. We stock pH 4, 7 and 10 precursor powders that can be used to make solutions of different pH. When you measure the pH of those solutions, stir the probes gently when you first immerse them, and be sure to wait for the probe voltage to stabilize when taking a measurement because their time constants are long. Finally, keep your hands away from the probes during measurement because the unshielded connections are sensitive to noise that can couple in through your body. Motor currents can couple through seawater to mess up this measurement too.</p>
<p>This <a href="http://www.ti.com/lit/an/snoa529a/snoa529a.pdf">application note</a> has a ballpark estimate for the output impedance of a pH probe, which is very high (order 1 G<span class="math inline">\(\Omega\)</span>). <a href="http://www.explainthatstuff.com/how-ph-meters-work.html">This</a> reference is a handy guide to the operation of pH sensors. The pH sensor guide explains that ions diffusing through glass, a slow process, provide the output current from a pH sensor, which explains why the output impedance for this sensor is so high.</p>
<p>You can amplify the voltage out of these probes using an MCP601 configured as a non-inverting amplifier. You must use a non-inverting amplifier because inverting amplifiers and offset amplifiers have input impedances that will react poorly with the probe’s very large output impedance; inverting amplifiers and offset amplifiers dangle the <span class="math inline">\(R_i\)</span> resistor off of the output node of the pH probe. (We also like the TL081 for this circuit because it has even higher input impedance than the MCP601, but putting a dual rail op-amp on your robot is deeply tedious work.)</p>
</section>
<section id="thermocouple-interface-circuit" class="level2">
<h2 class="anchored" data-anchor-id="thermocouple-interface-circuit">Thermocouple Interface Circuit</h2>
<p>Thermocouples generate very small voltages, so the Voltages must be amplified to be read by the Teensy. The easiest way to do the amplification is with an instrumentation amplifier. The one we have available is the Analog Devices AD623ANZ (data sheet <a href="./assets/AD623.pdf">here</a>).</p>
<p>Pay special attention to the AD623 voltage supply range. It can operate with a dual rail supply Voltage of ±2.5 V to ±6 V, or it can operate with a single rail supply voltage from 0V to 5-12V. If you exceed the voltage supply range, you will destroy the chip. The op-amp standard of ±15 V will destroy it immediately. Don’t be tempted.</p>
<p>Figure 79 in the AD623 data sheet shows the basic circuit for connecting a thermocouple. Note that in Figure 79, the amplifier is powered with a dual rail supply. You should use a single rail supply because your AUV will be powered by a battery. However, when you use a single rail you must also offset your thermocouple Volage to mid-rail (e.g., if you supply with 0-to-5 V, your thermocouple should be offset to 2.5 V). The circuit shown below in <a href="#fig-AD623-circuit" class="quarto-xref">Figure&nbsp;6</a> will accomplish that offset. Note that the offset uses a unity-gain, non-inverting op-amp to provide a low output impedance for the offset voltage.</p>
<div id="fig-AD623-circuit" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-AD623-circuit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="./img/AD623-circuit.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-AD623-circuit-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;6: Schematic for AD623 thermocouple circuit.
</figcaption>
</figure>
</div>
<p>You’ll need a thermocouple to test this amplifier, and we have spare type-E thermocouple wire available (specifically, <a href="https://www.omega.com/en-us/search/?text=FF-E-24-SLE-200">Omega FF-E-24-SLE-200</a>). The simplest way to construct a thermocouple for this task is to use one of the recycled ones. Otherwise, take a 1-foot length of thermocouple wire, strip the wires at one end and twist them firmly together so they make electrical contact. DO NOT USE SOLDER. It will not stick to the wires.</p>
<p>You’ll also need cold junction compensation. We recommend using a solid-state linear sensor (because temperature inside your robot should be pretty constant). You’ll need ot keep the solid-state linear sensor and the cold junction in good thermal contact, and a block of metal can provide a thermally conductive platform to mount your sensors.</p>
<p>The AD623 is expensive ($7/chip), so return undamaged chips to stock.</p>
</section>
<section id="acoustic-time-of-flight-distance-measurements" class="level2">
<h2 class="anchored" data-anchor-id="acoustic-time-of-flight-distance-measurements">Acoustic Time-of-flight Distance Measurements</h2>
<p>You can measure the distance between a speaker and an object by launching a pulse of sound then measuring how long it takes to receive an echo. This is called a time-of-flight (ToF) measurement. Implementing ToF on a robot requires a transmit (TX) circuit, a receive (RX) circuit and some special software.</p>
<p><strong>For TX</strong>, we recommend using the <a href="http://www.ti.com/lit/ds/symlink/lm384.pdf">LM384</a> audio amplifier to drive the <a href="https://drive.google.com/open?id=1Jrxe618k8KY_t4pc5sp_lyUTn6-bCDne">DAEX25W-8</a> speaker. The “Typical 5 W Amplifier” reference circuit in the LM384 datasheet is a good design for our purposes, though we can make a few small changes to improve it by omitting the volume control potentiometer and adding some bypass and coupling capacitors. These changes are illustrated below:</p>
<div id="fig-tof-tx" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tof-tx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/tof_tx.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tof-tx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;7: Acoustic time-of-flight transmit circuit.
</figcaption>
</figure>
</div>
<p>If you want to simplify your Teensy code, you can drive this circuit with a 555 timer instead of the Teensy. If you do so, note that you can easily turn your timer on and off, and therefore turn your speaker on and off, by controlling the 555 reset pin with a Teensy output pin. Adding a pull-down resistor between the 555 reset pin and ground can prevent annoying squawks while the Teensy starts up.</p>
<p><strong>For RX</strong>, you will need to build an amplifier. There are several possible strategies for this amplifier, and we recommend one of the simplest here: we recommend using only non-inverting amplifiers. Doing so will deliberately cause your zero-centered microphone signal to clip, so we are throwing away possible signal power in favor of a simple implementation. However, we only care about the presence/absence of a signal, so clipping isn’t a problem if we can muster enough gain. Depending on the range you’re working at, you may need a gain as high as 10,000, but we’ve seen OK results with gains in the 100-1000 range. You will need to split this gain across several stages to avoid running afoul of your op-amp’s gain-bandwidth product.</p>
<p>Two extra circuits in the receive chain can simplify your analysis work. A filter tuned to your transmit freuqency will prevent your very-high-gain amplifier from picking up ocean noise (e.g.: boat propellors). A second-order, band-pass <a href="https://en.wikipedia.org/wiki/Sallen%E2%80%93Key_topology">Sallen-Key filter</a> has worked in the past, and so has a cascade of op-amp low-pass and high-pass filters. Finally, a max detector at the end of your receive chain reduces the required sampling rate on the Teensy.</p>
<p>These recommendations are combined in the figure below:</p>
<div id="fig-tof-rx" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-tof-rx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="img/tof_rx.png" class="img-fluid figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-tof-rx-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;8: Acoustic time-of-flight receive circuit.
</figcaption>
</figure>
</div>
<p><strong>For software</strong>, you will need to increase the sampling rate of the Teensy. You can do so using the <a href="https://github.com/HMC-E80/E80/blob/main/libraries/main/BurstADCSampler.cpp">BurstADCSampler</a> library provided in our default Github package. Invoking <code>BurstADCSampler</code> by calling <code>burst_adc.sampler()</code> in the main <code>Default_Robot.ino</code> will cause the ADC to rapidly sample data (at about 7.4 kHz) and save that burst data to a separate file. You need to disable analog read averaging to use the <code>BurstADCSampler</code>, and you do that by adding the following line to your <code>Default_Robot.ino</code> setup function:</p>
<pre><code>void setup() {
    analogReadAveraging(0);
    ... 
    EXISTING SETUP CODE 
    ...
}</code></pre>
<p>If you are trying to drive your speaker pin directly instead of using a 555 timer, you will need to use the Teensy’s <code>analogWrite</code> functionality. Do so by editing <code>Pinouts.h</code> to set <code>SPEAKER_PIN</code> to your speaker output pin number. Then add the lines below to your setup function, and trigger a write by running <code>analogWrite(SPEAKER_PIN, 0)</code> in <code>Default_Robot.ino</code>.</p>
<pre><code>void setup() {
    pinMode(SPEAKER_PIN, OUTPUT);
    // set frequency to 3 kHz, change for your application
    analogWriteFrequency(SPEAKER_PIN, 3000); 
    ...
    EXISTING SETUP CODE
    ...
}</code></pre>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-1-contents" aria-controls="callout-1" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
In-Lab Audio Tests
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-1" class="callout-1-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p><strong>For Testing</strong>, it’s handy to be able to test your circuit from a function generator without getting all the Teensy code working. The old function generators (the <a href="https://www.keysight.com/us/en/assets/9018-04436/user-manuals/9018-04436.pdf">HP/Agilent 33120A</a>) can help with that. You can send a burst of sine waves, i.e.: a small number of sine wave cycles, by using internally triggered burst modulation on the <a href="https://www.keysight.com/us/en/assets/9018-04436/user-manuals/9018-04436.pdf">HP/Agilent 33120A</a>. This function is not available on the function generators built into the oscilloscope.</p>
<p>You can control burst mode by pressing the series of keys shown below. Read the manual for clarification on how these key presses work.</p>
<ul>
<li>Turn burst modulation mode on: Shift + the ramp/burst button / The text ‘burst’ will be highlighted at the top of the screen.</li>
<li>Turn burst modulation mode off: Shift + the ramp/burst button / The text ‘burst’ will no longer be highlighted at the top of the screen.</li>
<li>Turn manual triggering on and internal triggering off: Shift + the TRIG button / The text ‘trig’ will be highlighted at the top of the screen</li>
<li>Turn manual triggering off and internal triggering on: Shift + the TRIG button / The text ‘trig’ will no longer be highlighted at the top of the screen</li>
<li>Change the number of cycles sent out in each burst or the burst repetition rate:</li>
<li>Shift + Enter / Screen says “A: Mod Menu,”</li>
<li>v / Screen says “AM Shape,”</li>
<li><blockquote class="blockquote">
<pre><code> / Screen says "AM Source,"</code></pre>
</blockquote></li>
<li><blockquote class="blockquote">
<pre><code> / Screen says "FM Shape,"</code></pre>
</blockquote></li>
<li><blockquote class="blockquote">
<pre><code> / Screen says "Burst CNT, "</code></pre>
</blockquote></li>
<li>v / Screen says some number.” OR &gt; / “Burst Rate,” and then V / “some number.”</li>
<li>Edit the number you see and press enter to save the setting.</li>
</ul>
<p>Sometimes the tank room is noisy. By gathering data that is synchronized with the signal you are sending and averaging over many samples, you can cancel out signals that are not at the same frequency as the burst repetition rate of your signal. This is called coherent averaging. Set this up using the following steps:</p>
<ul>
<li>Use a second oscilloscope channel to probe the output of your function generator (or attach the trigger output of your function generator to your scope’s trigger input)</li>
<li>Trigger your oscilloscope on the channel attached to the output of the function generator (or on the trigger input)</li>
<li>Set your oscilloscope to normal mode acquisition (so that it will only capture a new screen of data when it receives a trigger) and adjust the horizontal position of your oscilloscope trigger so that you don’t waste samples recording data before you send out a burst.<br>
</li>
<li>Turn on averaging on your oscilloscope using the Acquisition/Mode button.</li>
</ul>
<p>You may refer to <a href="https://drive.google.com/file/d/1oBBkm4o01ZZupTHBEN3McYiGxioi8_sz/view?usp=sharing">this picture</a> of an example range finding setup. It is extremely important that your electronics and the tank water are not mixed, so <a href="https://drive.google.com/file/d/1MLQDMKdA0Lh1eyxujIAGwgewM1vTXVeF/view?usp=sharing">Use tape to hold electronics down</a> so they can’t fall into the tank, and <a href="https://drive.google.com/file/d/1MLQDMKdA0Lh1eyxujIAGwgewM1vTXVeF/view?usp=sharing">keep bench top equipment as far from the tank edge as possible</a>. Always dry your test apparatus with a towel as you remove it from the water and be mindful of nearby electrical setups.</p>
</div>
</div>
</div>
</section>
<section id="auv-turbidity-meter" class="level2">
<h2 class="anchored" data-anchor-id="auv-turbidity-meter">AUV Turbidity Meter</h2>
<p>This design adapts the lab turbidity meter to the requirements for being immersed and waterproofed. The instructions and procedure are <a href="https://drive.google.com/open?id=1RYaInz-txbC4iaJD83_0HSwKYBlVGDN1HlEs4yDEMjM">here</a>. A zip file of the design files is <a href="https://drive.google.com/open?id=10QO_RUk4GNhHB0n_1xPkC-ebEDFHg0sX">here</a>.</p>
</section>
<section id="anemometer" class="level2">
<h2 class="anchored" data-anchor-id="anemometer">Anemometer</h2>
<p>An anemometer is used for measuring wind speed. It is useful for a surface vehicle, but not so much for a submersible. The instructions and procedures are <a href="https://drive.google.com/open?id=1rY2bEjX3RP1EuHBjaoB50aiPz61I9q4W86KAzeNQdSo">here</a>. A zip file of the design documents is <a href="https://drive.google.com/open?id=10PVtvyJ87abJO67Chued8QdySKAWsk1L">here</a>.</p>
</section>
<section id="weather-vane" class="level2">
<h2 class="anchored" data-anchor-id="weather-vane">Weather Vane</h2>
<p>A weather vane is used for indicating wind direction relative to the local coordinates of a surface craft. It is not so useful for a submersible. There are three possible sensors for the weather vane.</p>
<ul>
<li>The first is the MLX90316. The instructions and procedure are <a href="https://drive.google.com/open?id=1f8EBwjwC41yVn9NPL-A11Ml1rJ3tqBN0ptcQc6E8O4U">here</a>.</li>
<li>The second is the ACE128. The instructions and procedures are <a href="https://drive.google.com/open?id=1nxSudsfMWcUmk4KY5xAjlgvL6IgpMP_TdypqefZIsCw">here</a>.</li>
<li>For convenience, a zip file of the design files for both is <a href="https://drive.google.com/open?id=10XoZwejIFrBTcVLfXJGrxdgBVczbB9Cn">here</a>.<br>
</li>
<li>The third is a simple potentiometer. If you attach the rotor to the weather vane, then as it rotates, the wiper output should produce a time varying analog voltage. This can run into issues with mechanical stiffness of the potentiometer, but the readout circuit is very easy (perhaps as simple as a unity gain buffer).</li>
</ul>
</section>
<section id="velocity-sensors" class="level2">
<h2 class="anchored" data-anchor-id="velocity-sensors">Velocity Sensors</h2>
<p>The reference design for the velocity sensor was not terribly successful. Perhaps you can learn from other’s mistakes. The instructions and procedures, such as they are, are <a href="https://drive.google.com/open?id=1i0zIxPvECrV4dE9XiX8ruwt7mzBVitFCy8Mf-ID--Qk">here</a>. A spreadsheet with the design calculations is <a href="https://drive.google.com/open?id=1H4uxriuP9vmXTxEPW2_xlxATGKS0cJR1Ro92NOTeYJc">here</a>. A spreadsheet with the experimental results is <a href="https://drive.google.com/open?id=17crtsGbjBhGFo32qSEhczJHauxY05IONGZRKeeFRNcI">here</a>. A zip archive with the design documents is <a href="https://drive.google.com/open?id=10QkiZIVQhM2UwSnC5YuN2zTD1xlhsCxi">here</a>.</p>
<p>Sufficiently ambitious teams might try using Doppler techniques with acoustic sensors to measure velocity. This type of measurement is called a frequency modulated continuous wave (FMCW) measurement because (1) unlike time of flight measurements, you transmit a continuous sine wave, and (2) you vary the frequency of your wave during operation. <a href="https://drive.google.com/file/d/0B7Ols9Km9Pa1Z205RDZ6SDczck0/view?usp=sharing">This document</a> describes the basics of FMCW processing. You’re on your own for making a triangle wave generator, a voltage controlled oscillator, and the receive mixers.</p>
<p>You can use recorded video of your robot, particularly if you have a reference scale in frame, to get a “true”, ground-truth measurement of velocity. <a href="http://www.videolan.org/vlc/index.html">VLC</a> works well as capture software for a USB camera, and tripod-stabilized phones also record great video. We recommend <a href="http://physlets.org/tracker/">tracker</a> for tracking video tracking software. Some some students have used <a href="https://www.vernier.com/products/software/video-physics">video-physics</a>. Make sure a length reference like a meter stick is visible in the image that you capture. Also, attach a brightly colored piece of pool noodle to your robot so that it is visible above the water. This will enable you to use auto tracking features in the video analysis software.</p>
</section>
<section id="future-designs" class="level2">
<h2 class="anchored" data-anchor-id="future-designs">Future Designs</h2>
<p>If you had a design that was particularly successful and you would like to share it with future generations of E80 students, let the professors know, and it may show up here.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/georgiatai\.github\.io\/e80-sp25-team35\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>